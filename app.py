import streamlit as st
import os
import re
from pathlib import Path
import shutil
import base64

class AutomatizadorRequerimentosWeb:
    def __init__(self):
        self.setup_page()
    
    def setup_page(self):
        """Configura a p√°gina do Streamlit para nuvem"""
        st.set_page_config(
            page_title="Automatizador Jur√≠dico - ONLINE",
            page_icon="‚öñÔ∏è",
            layout="wide"
        )
        
        st.title("üåê Automatizador de Requerimentos - VERS√ÉO ONLINE")
        st.success("‚úÖ Esta vers√£o est√° HOSPEDADA NA NUVEM e dispon√≠vel 24/7!")
        st.markdown("""
        **Automatize o processamento de documentos jur√≠dicos**  
        Sistema sempre dispon√≠vel para organizar requerimentos de forma eficiente.
        """)
    
    def get_folder_paths(self):
        """Interface para usu√°rio definir os diret√≥rios"""
        st.sidebar.header("üìÅ Configura√ß√µes de Pastas")
        
        with st.sidebar.expander("Configurar Diret√≥rios", expanded=True):
            st.write("Selecione as pastas no seu computador:")
            
            # Pasta dos PDFs (WhatsApp)
            st.subheader("üì• Pasta dos PDFs (WhatsApp)")
            pasta_downloads = st.text_input(
                "Pasta onde est√£o os PDFs baixados do WhatsApp:",
                value="",
                help="Digite o caminho completo da pasta ou use o bot√£o para selecionar",
                key="pasta_downloads_input"
            )
            
            col1, col2 = st.columns([3, 1])
            with col1:
                if st.button("üìÅ Selecionar Pasta PDFs", key="btn_pasta_downloads"):
                    st.info("üí° Navegue at√© a pasta onde est√£o os PDFs do WhatsApp")
            with col2:
                if st.button("üîÑ Limpar", key="btn_clear_downloads"):
                    pasta_downloads = ""
            
            st.divider()
            
            # Pasta dos Clientes (Drive)
            st.subheader("üìÇ Pasta dos Clientes (Drive)")
            pasta_clientes = st.text_input(
                "Pasta onde ser√£o criadas as pastas dos clientes:",
                value="", 
                help="Digite o caminho completo da pasta de destino",
                key="pasta_clientes_input"
            )
            
            col1, col2 = st.columns([3, 1])
            with col1:
                if st.button("üìÅ Selecionar Pasta Clientes", key="btn_pasta_clientes"):
                    st.info("üí° Navegue at√© a pasta onde criar as pastas dos clientes")
            with col2:
                if st.button("üîÑ Limpar", key="btn_clear_clientes"):
                    pasta_clientes = ""
            
            st.divider()
            
            # Pasta de Processamento
            st.subheader("‚öôÔ∏è Pasta de Processamento")
            pasta_processados = st.text_input(
                "Pasta tempor√°ria para processamento:",
                value="", 
                help="Digite o caminho completo da pasta tempor√°ria",
                key="pasta_processados_input"
            )
            
            col1, col2 = st.columns([3, 1])
            with col1:
                if st.button("üìÅ Selecionar Pasta Processamento", key="btn_pasta_processados"):
                    st.info("üí° Navegue at√© a pasta para arquivos tempor√°rios")
            with col2:
                if st.button("üîÑ Limpar", key="btn_clear_processados"):
                    pasta_processados = ""
        
        return pasta_downloads, pasta_clientes, pasta_processados

    def upload_files_interface(self):
        """Interface para upload de arquivos"""
        st.header("üì§ Fazer Upload dos PDFs")
        
        uploaded_files = st.file_uploader(
            "Selecione os PDFs do WhatsApp",
            type=['pdf'],
            accept_multiple_files=True,
            help="Selecione todos os PDFs que deseja processar"
        )
        
        if uploaded_files:
            st.success(f"‚úÖ {len(uploaded_files)} arquivo(s) selecionado(s)")
            
            # Mostrar preview dos arquivos
            with st.expander("üìã Arquivos Selecionados"):
                for file in uploaded_files:
                    st.write(f"üìÑ {file.name} ({file.size / 1024:.1f} KB)")
            
            return uploaded_files
        return None

    def save_uploaded_files(self, uploaded_files, pasta_downloads):
        """Salva os arquivos enviados para a pasta de downloads"""
        saved_files = []
        
        # Verifica se a pasta existe
        if not pasta_downloads:
            st.error("‚ùå Por favor, selecione uma pasta para os PDFs primeiro")
            return saved_files
        
        if not os.path.exists(pasta_downloads):
            st.error(f"‚ùå Pasta n√£o existe: {pasta_downloads}")
            return saved_files
        
        for uploaded_file in uploaded_files:
            try:
                file_path = os.path.join(pasta_downloads, uploaded_file.name)
                with open(file_path, "wb") as f:
                    f.write(uploaded_file.getbuffer())
                saved_files.append(file_path)
                st.info(f"üíæ Salvo: {uploaded_file.name}")
            except Exception as e:
                st.error(f"‚ùå Erro ao salvar {uploaded_file.name}: {e}")
        
        return saved_files

    def extract_client_name(self, caminho_pdf):
        """Extrai nome do cliente do nome do arquivo"""
        try:
            nome_arquivo = Path(caminho_pdf).stem
            # Remove sufixos comuns
            nome_limpo = re.sub(r'(_rotacionado|_pagina_\d+)$', '', nome_arquivo)
            nome_limpo = re.sub(r'[_-]', ' ', nome_limpo)
            
            # Tenta capitalizar como nome pr√≥prio
            palavras = nome_limpo.split()
            if len(palavras) >= 2:
                nome_cliente = ' '.join(palavras[:2]).title()
            else:
                nome_cliente = nome_limpo.title()
            
            return nome_cliente
        except Exception as e:
            return Path(caminho_pdf).stem

    def organize_files(self, saved_files, pasta_clientes):
        """Organiza os arquivos em pastas por cliente"""
        st.header("üìÅ Organizando Pastas dos Clientes")
        
        # Verifica se a pasta existe
        if not pasta_clientes:
            st.error("‚ùå Por favor, selecione uma pasta para os clientes primeiro")
            return 0, 0
        
        if not os.path.exists(pasta_clientes):
            st.error(f"‚ùå Pasta n√£o existe: {pasta_clientes}")
            return 0, 0
        
        progress_bar = st.progress(0)
        total_files = len(saved_files)
        
        pastas_criadas = 0
        arquivos_organizados = 0
        
        for i, pdf_path in enumerate(saved_files):
            try:
                # Extrair nome do cliente
                nome_cliente = self.extract_client_name(pdf_path)
                
                # Limpar nome para pasta
                nome_pasta = re.sub(r'[<>:"/\\|?*]', '', nome_cliente).strip()
                caminho_pasta = os.path.join(pasta_clientes, nome_pasta)
                
                # Criar pasta se n√£o existir
                pasta_nova = False
                if not os.path.exists(caminho_pasta):
                    os.makedirs(caminho_pasta)
                    pasta_nova = True
                    pastas_criadas += 1
                
                # Copiar arquivo
                nome_arquivo = Path(pdf_path).name
                caminho_destino = os.path.join(caminho_pasta, nome_arquivo)
                shutil.copy2(pdf_path, caminho_destino)
                arquivos_organizados += 1
                
                if pasta_nova:
                    st.success(f"üìÅ {nome_arquivo} ‚Üí üÜï {nome_pasta}/")
                else:
                    st.success(f"üìÑ {nome_arquivo} ‚Üí {nome_pasta}/")
                
            except Exception as e:
                st.error(f"‚ùå Erro ao organizar {pdf_path}: {e}")
            
            # Atualizar barra de progresso
            if total_files > 0:
                progress_bar.progress((i + 1) / total_files)
        
        return pastas_criadas, arquivos_organizados

    def create_download_link(self, file_path):
        """Cria link para download do arquivo"""
        with open(file_path, "rb") as f:
            bytes_data = f.read()
        b64 = base64.b64encode(bytes_data).decode()
        href = f'<a href="data:application/octet-stream;base64,{b64}" download="{os.path.basename(file_path)}">üì• Download {os.path.basename(file_path)}</a>'
        return href

    def run_automation(self):
        """Fun√ß√£o principal que executa toda a automa√ß√£o"""
        # Obter configura√ß√µes de pastas
        pasta_downloads, pasta_clientes, pasta_processados = self.get_folder_paths()
        
        # Bot√£o de executar
        st.header("üöÄ Executar Automa√ß√£o")
        
        if st.button("‚ñ∂Ô∏è EXECUTAR ORGANIZA√á√ÉO DE ARQUIVOS", type="primary", use_container_width=True):
            
            # Verificar se as pastas foram selecionadas
            if not pasta_downloads or not pasta_clientes:
                st.error("‚ùå Por favor, selecione todas as pastas necess√°rias")
                return
            
            # Fazer upload de arquivos
            uploaded_files = self.upload_files_interface()
            
            if not uploaded_files:
                st.warning("‚ö†Ô∏è Por favor, fa√ßa upload dos PDFs primeiro")
                return
            
            # Salvar arquivos enviados
            with st.status("üì• Salvando arquivos...", expanded=True) as status:
                saved_files = self.save_uploaded_files(uploaded_files, pasta_downloads)
                if saved_files:
                    status.update(label="‚úÖ Arquivos salvos com sucesso!", state="complete")
                else:
                    status.update(label="‚ùå Erro ao salvar arquivos", state="error")
                    return
            
            # Organizar arquivos
            pastas_criadas, arquivos_organizados = self.organize_files(saved_files, pasta_clientes)
            
            # Mensagem final
            if arquivos_organizados > 0:
                st.balloons()
                st.success(f"""
                üéâ **Organiza√ß√£o Conclu√≠da com Sucesso!**

                **üìä Resumo:**
                - üìÑ {len(saved_files)} arquivo(s) processado(s)
                - üìÅ {pastas_criadas} nova(s) pasta(s) de cliente(s) criada(s)
                - ‚úÖ {arquivos_organizados} arquivo(s) organizado(s)
                """)
                
                # Mostrar links para download
                st.header("üì• Downloads Dispon√≠veis")
                st.info("üí° **Dica:** Fa√ßa download dos arquivos organizados")
                
                for root, dirs, files in os.walk(pasta_clientes):
                    for file in files:
                        if file.endswith('.pdf'):
                            file_path = os.path.join(root, file)
                            st.markdown(self.create_download_link(file_path), unsafe_allow_html=True)

    def show_folder_structure(self):
        """Mostra a estrutura de pastas atual"""
        st.sidebar.header("üìä Estrutura de Pastas")
        
        pasta_downloads, pasta_clientes, pasta_processados = self.get_folder_paths()
        
        if st.sidebar.button("üîÑ Atualizar Visualiza√ß√£o", use_container_width=True):
            try:
                downloads_count = len(list(Path(pasta_downloads).glob("*.pdf"))) if pasta_downloads and os.path.exists(pasta_downloads) else 0
                clientes_count = len([f for f in Path(pasta_clientes).iterdir() if f.is_dir()]) if pasta_clientes and os.path.exists(pasta_clientes) else 0
                
                col1, col2 = st.sidebar.columns(2)
                with col1:
                    st.metric("üì• PDFs para Processar", downloads_count)
                with col2:
                    st.metric("üìÅ Pastas de Clientes", clientes_count)
                
            except Exception as e:
                st.sidebar.error(f"Erro ao ler estrutura: {e}")

# FUN√á√ÉO PRINCIPAL - ESTA PARTE ESTAVA FALTANDO!
def main():
    # Criar inst√¢ncia da classe
    app = AutomatizadorRequerimentosWeb()
    
    # Mostrar estrutura de pastas
    app.show_folder_structure()
    
    # Executar automa√ß√£o
    app.run_automation()
    
    # Instru√ß√µes de uso
    with st.expander("üìã Instru√ß√µes de Uso - VERS√ÉO CLOUD"):
        st.markdown("""
        **üåê COMO USAR ESTA VERS√ÉO ONLINE:**

        1. **üìÅ Configurar Pastas** (barra lateral):
           - Selecione as pastas no seu computador
           - Pasta PDFs: onde est√£o os arquivos do WhatsApp
           - Pasta Clientes: onde criar as pastas organizadas

        2. **üì§ Fazer Upload dos PDFs**:
           - Selecione todos os PDFs baixados do WhatsApp
           - Podem ser m√∫ltiplos arquivos de uma vez

        3. **üöÄ Executar Organiza√ß√£o**:
           - Clique no bot√£o "EXECUTAR ORGANIZA√á√ÉO DE ARQUIVOS"
           - O sistema organizar√° os PDFs em pastas por cliente

        4. **üì• Fazer Download**:
           - Use os links de download para baixar os arquivos organizados
           - Fa√ßa upload manual para seu Google Drive real
        """)

# Este if √© ESSENCIAL para o Streamlit funcionar
if __name__ == "__main__":
    main()